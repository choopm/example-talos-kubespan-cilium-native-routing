# Talos KubeSpan + cilium Native-Routing

This serves as a demo and documentation when utilizing Talos
[KubeSpan](https://docs.siderolabs.com/talos/v1.11/networking/kubespan#kubespan)
for [Native-Routing](https://docs.cilium.io/en/v1.18/network/concepts/routing/#arch-direct-routing)
in cilium.

The [Taskfile.yml](Taskfile.yml) wraps most commands required to configure a
working demo cluster. You are required to provide IP addresses via `vars`.

Get started by booting your Talos nodes and ensure these are in maintenance mode.
Note the IP addresses and configure the `CONTROLPLANES` and `WORKERS` variables
inside the [Taskfile.yml](Taskfile.yml).
>This test was performed using 4 QEMU/KVM machines

Enusre requirements are installed:
- [talosctl](https://docs.siderolabs.com/talos/v1.11/getting-started/talosctl)
- [task](https://taskfile.dev/)
- [helm](https://helm.sh/)
- [yq](https://github.com/mikefarah/yq/)

Afterwards you should be able to start everything using:

```shell
task gen-talos
task bootstrap
export KUBECONFIG="$(pwd)/kubeconfig"
export TALOSCONFIG="$(pwd)/talosconfig"

# ... wait until everything is ready
kubectl get nodes -o wide

# demo deploy
task deploy-example
task test-example
```

Check the available tasks using `task --list` for more info.

## The actual missing parts

When using the DaemonSet approach to add the node's pod CIDR to the cilium_host
interface, most things will work, but you will encounter issues when trying to
use some cilium features such as Node-IPAM-LB or Egress-Gateway.

The underlying cause is that few packets sent by cilium from it's cilium_host
interface might end up skipping the KubeSpan interception and end up being
natively-routed to the host network. This is undesired and needs to be fixed.

There are different solutions to this:

Working solutions:

- Provide a static route for pod CIDRs to ensure packets generated by cilium
  are sent through the kubespan interface aswell.
  `ip route add 10.244.0.0/16 dev kubespan`
  This was added to the original DaemonSet provided by [alexandrem](https://github.com/alexandrem)
  in [the comments](https://github.com/siderolabs/talos/issues/9043#issuecomment-2419640013).

Untested/unrecommended/potential solutions:

- Bind the cilium_host device directly to the KubeSpan WireGuard interface.
  This might cause other issues with host-network traffic in cases where any of
  the kubespan tunnels are not available. For now do not consider trying this.
  Would be done using something like `extraArgs=--host-device=kubespan`
- Advertise the node's pod CIDR through BGP to other nodes, tricky and extra work

## Notes and credits

>Not all cilium options you will find in the Taskfile are required but have been
used to test stuff. See `task deploy-example`.

A huge *THANK YOU <3* to [alexandrem](https://github.com/alexandrem) and
all other people from <https://github.com/siderolabs/talos/issues/9043>.
